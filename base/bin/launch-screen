#!/bin/bash
set -eu

die() {
  echo "ERROR: $*" >&2
  exit 1
}

get_shell() {
  local s
  s="$(getent passwd "$USER" | cut -d: -f7)"
  [ -n "$s" -a -f "$s" -a -x "$s" ] || s="/bin/bash"
  [ -n "$s" -a -f "$s" -a -x "$s" ] || s="/bin/sh"
  echo "$s"
}

if [ $# -gt 0 ]; then
  session=$1
  shift
else
  session=main
fi

[ $# -eq 0 ] || die "Too many arguments"

TERM="xterm-256color"
: ${HOSTNAME:=$(hostname)}
: ${USER:=$(id -un)}
: ${LOGNAME:=$USER}
: ${HOME:=~}
: ${SHELL:=$(get_shell)}
: ${PATH:="/usr/local/bin:/usr/bin:/bin"}

exec \
  setsid \
  env -i \
    DISPLAY=":0" \
    HOME="$HOME" \
    HOSTNAME="$HOSTNAME" \
    LOGNAME="$LOGNAME" \
    PATH="$PATH" \
    SHELL="$SHELL" \
    TERM="$TERM" \
    USER="$USER" \
    ${KRB5CCNAME:+KRB5CCNAME="$KRB5CCNAME"} \
  ssh-agent \
  screen \
    -c "$HOME/.screenrc-launch" \
    -S "$session" \
    -D -m
