#!/bin/bash
set -e

die() {
  echo "Error: $*" >&2
  exit 1
}

if [ $# -gt 0 ]; then
  session=$1
  shift
else
  session=main
fi

[ $# -eq 0 ] || die "Too many arguments"

TERM=xterm-256color
HOSTNAME=$(hostname)
[ -n "$HOSTNAME" ] || die "Hostname not set"

uid=$(id -u)
[ -n "$uid" ] || die "Broken system: 'id -u' failed"

pw=""
for key in "$LOGNAME" "$USER" "$uid"; do
  pw=$(getent passwd "$key" || true)
  [ -z "$pw" ] || break
done

[ -n "$pw" ] ||
  die "Failed to getent passwd"
[ -n "$(echo "$pw" | cut -d: -f7)" ] ||
  die "Missing field(s) in [$pw]"
pw_uid=$(echo "$pw" | cut -d: -f3)
[ "$uid" -eq "$pw_uid" ] ||
  die "UID mismatch: [$USER] has uid $pw_uid, you have uid $uid"

USER=$(echo "$pw" | cut -d: -f1)
HOME=$(echo "$pw" | cut -d: -f6)
SHELL=$(echo "$pw" | cut -d: -f7)

exec \
  setsid \
  env -i \
    HOSTNAME="$HOSTNAME" \
    TERM="$TERM" \
    USER="$USER" \
    LOGNAME="$USER" \
    HOME="$HOME" \
    SHELL="$SHELL" \
    PATH="$PATH" \
    DISPLAY=":0" \
    ${KRB5CCNAME:+KRB5CCNAME="$KRB5CCNAME"} \
  ssh-agent \
  screen \
    -c "$HOME/.screenrc-launch" \
    -S "$session" \
    -D -m
